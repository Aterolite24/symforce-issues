//  -----------------------------------------------------------------------------
// This file was autogenerated by symforce. Do NOT modify by hand.
//
// Instead modify:
//     symforce/codegen/cpp/templates/cam_package/example/cam_function_codegen_cpp_test.cc.cc.jinja
//
// And then run `symforce_function_codegen_test --update`.
// -----------------------------------------------------------------------------
/**
 * Tests for generated functions that accept C++ camera types as arguments. Mostly testing that everything
 * compiles.
 */

#include <iostream>
#include <Eigen/Dense>

// TODO(nathan): We just test linear camera for now, but could/should test other types in the future
#include <cam/linear_camera_cal.h>
#include "./symforce_function_codegen_test_data/pixel_to_ray_and_back.h"

// TODO(hayk): Use the catch unit testing framework (single header).
#define assertTrue(a)                                      \
  if (!(a)) {                                              \
    std::ostringstream o;                                  \
    o << __FILE__ << ":" << __LINE__ << ": Test failure."; \
    throw std::runtime_error(o.str());                     \
  }

template <typename T>
void TestGeneratedFunction() {
  using Scalar = typename T::Scalar;

  Eigen::Matrix<Scalar, geo::StorageOps<T>::StorageDim(), 1> data = Eigen::Matrix<Scalar, geo::StorageOps<T>::StorageDim(), 1>::Random();

  T cam(data);
  std::cout << "*** Testing generated function with " << cam << " ***" << std::endl;

  Scalar epsilon = 1e-6;
  int is_valid;

  Eigen::Matrix<Scalar, 2, 1> pixel_coords = Eigen::Matrix<Scalar, 2, 1>::Random();
  Eigen::Matrix<Scalar, 2, 1> pixel_coords_reprojected = pixel_to_ray_and_back_gen::PixelToRayAndBack<Scalar>(pixel_coords, cam, epsilon);
  assertTrue(pixel_coords.isApprox(pixel_coords_reprojected, epsilon));
}

int main(int argc, char** argv) {
  {% for scalar in scalar_types %}
  TestGeneratedFunction<cam::LinearCameraCal<{{ scalar }}>>();
  {% endfor %}
}
